---
title: "Report"
author: "Thomas Debray"
date: "7-12-2021"
output: html_document
---

```{r setup, include=FALSE}
# Set document properties
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

source("../R/functions.r")

library(ggplot2)

################################################################################
# Prepare data
################################################################################
dat <- load_imputed_data("F:/Projects/Datasets/Weights disease risk score/IDB_control_imputed.rda")

dat_baseline <- dat %>% 
  group_by(USUBJID.x, TRIAL) %>% 
  filter(AVISITN == 0) %>%
  summarize(
    AGE = first(AGE),
    SEX = first(MaleGender),
    RACE = first(WhiteRace),
    WEIGHTBL = first(WEIGHTBL),
    ONSYRS = first(ONSYRS),
    DIAGYRS = first(DIAGYRS),
    RLPS1YR = first(RLPS1YR),
    RLPS3YR = first(RLPS3YR),
    EDSSBL = first(EDSSBL),
    GDLESBL = first(GDLESBL),
    T1LESBL = first(T1LESBL),
    T2LESBL = first(T2LESBL),
    PRMSGR = first(PRMSGR),
    NHPTMBL = first(NHPTMBL),
    PASATABL = first(PASATABL),
    T25FWABL = first(T25FWABL),
    TRELMOS = first(TRELMOS),
    SFMCSBL = first(SFMCSBL),
    SFPCSBL = first(SFPCSBL),
    BVZBL = first(BVZBL),
    VFT25BL = first(VFT25BL)
)

npat <- nrow(dat_baseline)
```

# Original data sources
Previously, four RCTs of relapsing-remitting multiple sclerosis (RRMS) were combined in an integrated clinical trial database. This database includes patient-level data from ADVANCE (pegylated interferon beta-1a s.c. registration trial), DEFINE and CONFIRM (dimethyl fumarate registration trials), and AFFIRM (natalizumab registration trial). Details of these trials are provided below:

* The ADVANCE trial includes `r  length(unique(subset(dat, TRIAL == "ADVANCE" & TRTA == "Placebo")$USUBJID.x))` patients who received placebo every 2 weeks for 48 weeks followed by 125 $\mu$g peginterferon beta-1a subcutaneously every 2 or 4 weeks for 48 weeks (https://www.clinicaltrials.gov/ct2/show/NCT00906399) 
* The DEFINE trial includes `r length(unique(subset(dat, TRIAL == "DEFINE" & TRTA == "Placebo")$USUBJID.x))` patients who received two placebo capsules orally three times daily (https://www.clinicaltrials.gov/ct2/show/NCT00420212)
* The CONFIRM trial includes `r length(unique(subset(dat, TRIAL == "CONFIRM" & TRTA == "Placebo")$USUBJID.x))` patients who received two placebo capsules orally three times daily (https://www.clinicaltrials.gov/ct2/show/NCT00451451) 
* The AFFIRM trial includes  `r length(unique(subset(dat, TRIAL == "AFFIRM" & TRTA == "Placebo")$USUBJID.x))` patients who received placebo, intravenous infusion, every 4 weeks, for up to 116 weeks.  (https://www.clinicaltrials.gov/ct2/show/NCT00027300)

We here consider the following baseline covariates:

* AGE - age (years)
* SEX - gender (1 = male, 0 = female)
* RACE - ethnicity, transformed as (1 = white, 0 = non-white)
* WEIGHTBL - weight (kg)
* ONSYRS - Time since first multiple sclerosis symptoms (years)
* DIAGYRS - Time since multiple sclerosis diagnosis (years)
* EDSSBL - Expanded Disability Status Scale (discrete)
* PRMSGR - Prior MS Treatment Group (1 = yes, 0 = no)
* NHPTMBL - 9 Hole Peg Test Average Score
* SFMCSBL - SF-36 mental component score
* SFPCSBL - SF-36 physical component score
* PASATABL -	PASAT 3 
* T25FWABL -  Timed 25 Foot Walk 
* VFT25BL -	VFT 2.5%
* Relapses
  * RLPS1YR - No. of Relapses within the previous 12 months 
  * RLPS3YR - No. of Relapses within the previous 3 years 
  * TRELMOS - No. of months Since Recent Pre-Study Relapse
* MRI findings
  * BVZBL -	Brain Volume Z-Score
  * GDLESBL - Number of Gd+ lesions 
  * T1LESBL - Number of T1 weighted lesions 
  * T2LESBL - Number of T2 weighted lesions 

MRI findings were only assessed for some trial participants. Missing values were therefore imputed using multiple imputation by chained equations. One imputed dataset was used for the analyses in the illustrative example.

```{r, fig.height = 20, fig.width = 10}
plot_density(dat_baseline)
```


# Hypothetical observational study
To mimic an observational study, we consider the ADVANCE trial as control group and combine the remaining three trials (AFFIRM, DEFINE and CONFIRM) into an active treatment group. The combined treatment groups have the following case-mix:

```{r, fig.height = 20, fig.width = 10}
# Prepare NRS dataset
dat_NRS <- prepare_nrs(dat, 
                       STUDYID_control = c("ADVANCE"), 
                       STUDYID_treat = c("AFFIRM", "DEFINE", "CONFIRM"), 
                       SUBGROUP = FALSE)

plot_density(dat_NRS, facet = "TrtGroup")
```
The treatment effect estimates in this study are as follows:
```{r}
results <- analyze_nrs(dat_NRS)

results <- data.frame("Method" = results$method,
                      "Reference" = 0,
                      "Estimate" = format(round(results$est_beta, 2), nsmall = 2),
                      "SE" = format(round(results$est_se, 2), nsmall = 2),
                      "95%CI" = paste(format(round(results$est_beta_CIl, 2), nsmall = 2), "; ", format(round(results$est_beta_CIu, 2), nsmall = 2)),
                      "Time" = format(round(results$est_time, 2), nsmall = 2))
knitr::kable(results)
```

```{r}
sim_NRS <- simulate_nrs(dat_NRS)
```

Afterwards, we introduce confounding by generating an artificial dataset with a predefined (truncated) Poisson distribution of baseline EDSS. The remaining covariate data are then generated according to the previously observed data distribution. To this purpose, we use multiple imputation with linear regression (continuous variables) and predictive mean matching (discrete covariates). The new dataset has a total of `r nrow(sim_NRS)` patients, with `r nrow(subset(sim_NRS, Trt == 0))` patients receiving control and `r nrow(subset(sim_NRS, Trt == 1))` patients receiving 'active' placebo. 

```{r, fig.height = 20, fig.width = 10}
plot_density(sim_NRS, facet = "TrtGroup")
```

The primary outcome for the hypothetical observational study is the Expanded Disability Status Scale (EDSS) measured 36 weeks after baseline. The EDSS score is a scale that quantifies disability in 0.5 unit increments, and ranges from 0 (no disability) to 10 (death due to MS).

```{r, fig.height = 20, fig.width = 10}
results <- analyze_nrs(sim_NRS)

results <- data.frame("Method" = results$method,
                      "Reference" = 0,
                      "Estimate" = format(round(results$est_beta, 2), nsmall = 2),
                      "SE" = format(round(results$est_se, 2), nsmall = 2),
                      "95%CI" = paste(format(round(results$est_beta_CIl, 2), nsmall = 2), "; ", format(round(results$est_beta_CIu, 2), nsmall = 2)),
                      "Time" = format(round(results$est_time, 2), nsmall = 2))
knitr::kable(results)
```

