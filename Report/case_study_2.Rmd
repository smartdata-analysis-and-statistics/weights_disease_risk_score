---
title: "Illustrative case study 2"
author: "Thomas Debray"
date: "This report was generated on `r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---


```{r setup, include=FALSE}
# Set document properties
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

source("../R/functions.r")

library(table1)
library(ggplot2)
```


```{r}
################################################################################
# Prepare data
################################################################################
d <- read.csv("F:/OneDrive Smart Data/OneDrive - Smart Data Analysis and Statistics/Research/Manuscripts/Long - PGS weighting/data/RCT_IST.csv")

dat <- data.frame(HOSPNUM = d$HOSPNUM,
                  OCCODE = d$OCCODE,
                  RXASP = d$RXASP,
                  RXHEP = d$RXHEP,
                  RDELAY = d$RDELAY,
                  AGE = d$AGE,
                  SEX = d$SEX,
                  RSLEEP = d$RSLEEP,
                  RCONSC = d$RCONSC,
                  RATRIAL = d$RATRIAL,
                  RSBP = d$RSBP,
                  STYPE = d$STYPE,
                  RDEF1 = d$RDEF1,
                  RDEF2 = d$RDEF2,
                  RDEF3 = d$RDEF3,
                  RDEF4 = d$RDEF4,
                  RDEF5 = d$RDEF5,
                  RDEF6 = d$RDEF6,
                  RDEF7 = d$RDEF7,
                  RDEF8 = d$RDEF8,
                  RVISINF = d$RVISINF,
                  RCT = d$RCT,
                  RASP3 = d$RASP3,
                  RHEP24 = d$RHEP24,
                  EXPDD = d$EXPDD)

dat_ASP <- subset(dat, RXASP == "Y")
```

The International Stroke Trial was a large, multi-center, randomized, placebo-controlled trial including `r nrow(dat)` stroke patients. The IST evaluated the effect of Aspirin on a primary composite outcome of death or dependency (i.e. absence of autonomy) at 6 months (binary outcome). In this illustrative case study, we focus on `r nrow(dat_ASP)` patients from IST database version 2 that were randomized to receive Aspirin. 

We excluded patients with

* Missing data for the primary outcome (N = `r length(which(dat_ASP$OCCODE == 9 | dat_ASP$OCCODE == 0))`)
* No information on whether Aspirin was administered within 3 days prior to randomisation  (N = `r length(which(!(dat_ASP$RASP3 %in% c("Y", "N"))))`)
* No information on whether Heparin was administered within 24 hours prior to randomisation (N = `r length(which(!(dat_ASP$RHEP24 %in% c("Y", "N"))))`)
* No information on the presence of atrial fibrillation (N = `r length(which(!(dat_ASP$RATRIAL %in% c("Y", "N"))))`)

```{r}
# Exclude patients
dat_ASP <- dat_ASP %>% filter(!(OCCODE %in% c(0,9)), 
                              RASP3 %in% c("Y", "N"),
                              RATRIAL %in% c("Y","N"),
                              RHEP24 %in% c("Y", "N"))



# codage
dat_ASP$outcome <- ifelse(dat_ASP$OCCODE == 1 | dat_ASP$OCCODE == 2, 1, 0)


dat_ASP$ASP <- ifelse(dat_ASP$RXASP == "Y", 1, 0)
dat_ASP$HEP <- ifelse(dat_ASP$RXHEP == "N", 0, 1)
dat_ASP$a <- ifelse(dat_ASP$RDELAY <= 8, 1, 0)
dat_ASP$y <- dat_ASP$outcome

dat_ASP$outcome <- factor(dat_ASP$outcome, 
                          levels = c(1,0), 
                          labels = c("Death or dependency at 6 months", "(not) recovered"))

dat_ASP$albl <- factor(dat_ASP$a, 
                    levels = c(1,0), 
                    labels = c("Early Aspirin administration", "Late Aspirin administration"))
```

Amongst patients enrolled in the Aspirin arm of the International Stroke Trial, less than a quarter received the treatment between 0 and 8 hours following the onset of symptoms (`r round(nrow(subset(dat_ASP, a == 1))/nrow(dat_ASP)*100,1)`%, N = `r nrow(subset(dat_ASP, a == 1))`). In this group, 1443 (66.8%) patients were recorded with death or dependency at 6 months versus 4248 (60.8%) in the group of patients who received Aspirin later (after 8 hours).


We here consider the following baseline covariates (some of which were imputed):

```{r}
table1(~ HOSPNUM + OCCODE + RXASP | albl, 
       data = dat_ASP, 
       caption = "Baseline characteristics.")
```

